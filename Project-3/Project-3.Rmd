---
title: "Project 3 - Premier League Home Advantage during COVID"
author: "Eliott Van Dieren"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: united
    number_sections: true
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(car)
library(knitr)
library(kableExtra)
```

# Introduction



# Data exploration

## Dataset Description


## Dataset transformations


```{r,echo=FALSE,message=FALSE,warning=FALSE}
m_1819 <- read.csv("Premier_League/2018-2019.csv")
m_1920 <- read.csv("Premier_League/2019-2020.csv")
m_2021 <- read.csv("Premier_League/2020-2021.csv")
m_2122 <- read.csv("Premier_League/2021-2022.csv")

m_1819$covid = "before"
m_1920$covid = "before"
m_2021$covid = "in"
m_2122$covid = "later"

kept_variables <- c("HomeTeam","AwayTeam","FTHG","FTAG","covid")

Data <- rbind(m_1819[,kept_variables],m_1920[,kept_variables],
              m_2021[,kept_variables],m_2122[,kept_variables])

AwayData <- Data
AwayData$home = 0
names(AwayData) <- c("opponent","team","opponent_goals","goals","covid", "home")


Data$home = 1
names(Data) <-  c("team","opponent","goals","opponent_goals", "covid", "home")


Data <- rbind(Data,AwayData)

str(Data)

Data <- Data %>% mutate(team=as.factor(team),
                        opponent = as.factor(opponent),
                        covid = as.factor(covid),
                        home = as.factor(home))

str(Data)

# $$log(Y_{i,j}) = \beta_1 \cdot H + \beta_2 \cdot C_{before} + \beta_3 \cdot C_{In} + \beta_4 \cdot C_{later} + \beta_3 \cdot H *  C + \beta_4 \cdot T_i + \beta_5 \cdot O_j $$
```


# Poisson Regression model

In a Poisson Regression setting, one can define the problem as follows : 
$$log(Y_{i,j}) = \beta_1 \cdot H + \beta_2 \cdot C_{in} + \beta_3 \cdot C_{later} + \beta_4 \cdot H *  C_{in} + \beta_5 \cdot H * C_{later} + \beta_6 \cdot T_i + \beta_7 \cdot O_j $$

where $Y_{i,j}$ is the expected number of goals scored by team $T_i$ against opponent team $O_j$, $H$ is a Boolean indicator saying whether the team $T_i$ plays at home. $C_{in,later}$ are respectively the Covid indicator to know whether the game happened during the covid preriod and afterwards. One notes that the period before Covid is implied by those two factors being equal to zero. $H \cdot  C_{in,later}$ marks the interaction between being at Home and playing during Covid or after covid.


Add table Home vs Covid wrt to the beta used

## Assumptions
In order to apply our model, one has to make some assumptions about the data and what the results will look like:

* We do not make a difference for the coefficients of a given team with respect to each season, therefore Manchester United will have the same coefficient between 2019 and 2022. One more step would be to make another boolean value with respect to the season or check the betting values to evaluate the strength of a given team with respect to the years, but that is out of the scope of this project.
* We do not take the relegation or promotion from the Premier League into account. This means that we do not remove those teams and therefore that the coefficients regarding certain teams might not be highly accurate as the number of games played by those relegated/promoted teams might be quite low.

## Model

We can now describe our model :

```{r}
prm <- glm(goals ~ team + opponent + home + covid + covid:home - 1, data=Data, family=poisson(link="log"))
```

As seen above, we have the response `goals` which is the number of goals scored by `team` during a match against `opponent`. Then, we try to predict this response by using the `team` and `opponent` factor, as well as the `covid` and `home` flag previously described. We also add the interaction between `covid` and `home` which enables us to more precisely describe the link between the home effect and whether the game was played before, during or after covid.

# Did home advantage persist through Covid?

To answer this question, we will answer four subsidiary questions to grasp the home advantage phenomenon a bit better:

* Was there home advantage before Covid?
* Did home advantage reduced during Covid?
* How did it evolved after Covid?
* What are the confidence intervals of those evolutions?

## Was there a home advantage before Covid?

```{r,echo=FALSE,warning=FALSE,message=FALSE}
summary(prm)
```

To statistically answer this question, one needs to take a look at the coefficients in front of the `home` variable. As the baseline factor for covid is `before`, one finds that the home effect before covid will be $exp(\beta_1)=1.21$. This means that when a team is playing at home, it gets $1.21$ times more goals than when playing away, all other parameters being equal (marginal effect) before covid hits.


## Did home advantage reduced during Covid?

To tackle this question, one can have a look at the interaction between the `home` and the `covidIn` flag. By using the same strategy as the previous question, we can simply sum the coefficients of `home` and `home:covidIn` which will give us the coefficient of the home advantage during coving. One finds $exp(\beta_1 + \beta_4) = exp(0.194 + -0.187) = 1.01$, meaning that during covid, the home advantage has nearly no impact on the expected goals, as playing at home will only increase the number of goals by $1\%$, which is highly reduced from before covid ($21\%$).

## How did it evolved after Covid? 
After covid, we can check the coefficient of `home:CovidLater` which is equal to $\beta_5 = -0.05$, meaning that there will be a slight decrease of the home effect after covid hits, but it does not cancels as during the covid lockdowns. Quantitatively, the home advantage after covid is equal to $exp(0.194-0.05) = 1.15$, meaning that there is a $15%$ increase of number of expected goals after covid due to home effect.

## What are the confidence intervals of those evolutions?

To do so, one can compute confidence intervals for each of the used, mainly $\beta_{1,4,5}$ using the `confint` command.

We obtain the following $5\%$ confidence intervals

Insert table


# Question 4

# Conclusion


# Appendix

## Full summary of the final model

