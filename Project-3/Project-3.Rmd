---
title: "Project 3 - Premier League Home Advantage during COVID"
author: "Eliott Van Dieren"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: united
    number_sections: true
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(car)
library(knitr)
library(kableExtra)
library(xtable)
```

# Introduction

In various sports, one defines the Home effect as the phenomenon whereby the home team gains a significant advantage against its opponent simply by playing at home, in a stadium being crowded by their supporters. Football makes no exception and it has been showed that the home effect is a robust phenomenon in European Leagues. In this project, we focus on the home effect in the English Premier League during Covid pandemic where the games were played behind closed door for $18$ months. One can therefore assess whether the home advantage persisted even though the supporters were not allowed in the stadiums anymore. Thanks to data gathered from all games between $2018$ and $2022$, one can compare the expected number of goals before, during and after covid as well, which helps understanding the home effect on football games. We summarize the contribution of this project by asking ourselves a single question : did home advantage persist through Covid?

In this project, we first start by exploring the given dataset, by describing its columns and by wrangling it to get better features to answer the main question. Secondly, we start looking at the Poisson Regression model which is used to model the expected number of goals and state various assumptions used in this project. Thirdly, we can answer the main question by having a look at the coefficients of various variables from our model and give interpretable confidence intervals for the quantities of interest (QoI). Lastly, we explore various stability studies and then conclude on the main results and next steps. 

# Data exploration

## Dataset Description

The studied [dataset](http://www.football-data.co.uk/matches.php) contains a list of EPL games from various seasons, with QoI such as number of goals from the home and away team, the number of off-sides, yellow and red cards, etc. In this project, we selected four seasons : $18-19,19-20,20-21$ and $20-22$. Hereunder is a list of variables used in this project:

* `HomeTeam` = Home Team
* `AwayTeam` = Away Team
* `FTHG` = Full Time Home Team Goals
* `FTAG` = Full Time Away Team Goals

## Dataset transformations

The first transformation made to the dataset is to create a factor `covid` which can take three different values : `before`, `in` and `later` which respectively represent the period before, during and after Covid. In our case, as the $19-20$ season only has the games played before the Covid breakthrough, we flagged both $18-19$ and $19-20$ seasons as `before`, the $20-21$ season as `in` and the $21-22$ season as `later`.

Once this is done, one has to duplicate each game to take it from each team's perspective, i.e. that for a given team, we will store its name, its opponent's, the number of goals scored by each team, a flag for Covid and another one to know whether the given team played at home. This means that we have a final dataset with the columns described below:

* `team` = Studied Team
* `opponent` = Opponent Team
* `goals` = Number of goals scored by the studied team
* `opponent_goals` = Number of goals scored by the opponent team (not used in the model but kept for completeness)
* `covid` = factor representing whether the game between `team` and `opponent` was played before, during or after covid
* `home` = factor representing whether `team` played at home or not.

```{r,echo=FALSE,message=FALSE,warning=FALSE}
m_1819 <- read.csv("Premier_League/2018-2019.csv")
m_1920 <- read.csv("Premier_League/2019-2020.csv")
m_2021 <- read.csv("Premier_League/2020-2021.csv")
m_2122 <- read.csv("Premier_League/2021-2022.csv")

m_1819$covid = "before"
m_1920$covid = "before"
m_2021$covid = "in"
m_2122$covid = "later"

kept_variables <- c("HomeTeam","AwayTeam","FTHG","FTAG","covid")

Data <- rbind(m_1819[,kept_variables],m_1920[,kept_variables],
              m_2021[,kept_variables],m_2122[,kept_variables])

AwayData <- Data
AwayData$home = 0
names(AwayData) <- c("opponent","team","opponent_goals","goals","covid", "home")


Data$home = 1
names(Data) <-  c("team","opponent","goals","opponent_goals", "covid", "home")


Data <- rbind(Data,AwayData)

Data <- Data %>% mutate(team=as.factor(team),
                        opponent = as.factor(opponent),
                        covid = as.factor(covid),
                        home = as.factor(home))

head(Data) %>% kable(digit=3,caption = "Description of the dataset") %>% kable_styling()

# $$log(Y_{i,j}) = \beta_1 \cdot H + \beta_2 \cdot C_{before} + \beta_3 \cdot C_{In} + \beta_4 \cdot C_{later} + \beta_3 \cdot H *  C + \beta_4 \cdot T_i + \beta_5 \cdot O_j $$
```


# Poisson Regression model

The Poisson regression is a member of a broad class of models known as the Generalized Linear Models (GLM), with the natural log as canonical link. In a Poisson Regression setting, one can define the problem as follows : 
$$log(Y_{i,j}) = \beta_1 \cdot H + \beta_2 \cdot C_{in} + \beta_3 \cdot C_{later} + \beta_4 \cdot H *  C_{in} + \beta_5 \cdot H * C_{later} + \beta_6 \cdot T_i + \beta_7 \cdot O_j $$
where $Y_{i,j}$ is the expected number of goals scored by team $T_i$ against opponent team $O_j$, $H$ is a Boolean indicator saying whether the team $T_i$ plays at home. $C_{in,later}$ are respectively the Covid indicator to know whether the game happened during the covid preriod and afterwards. One notes that the period before Covid is implied by those two factors being equal to zero. $H \cdot  C_{in,later}$ marks the interaction between being at Home and playing during Covid or after covid. One notes that to answer the main question, knowing the teams (variables $T_i$ and $O_j$) would not be necessary. However, after looking at various metrics such as the AIC, BIC and the residual deviance, knowing the team helps us getting more accurate predictions and is therefore kept in our model (see [Comparison of models] for more details).

To sum it up, one finds hereunder a table summarizing the coefficients used to predict the expected number of goals for a given situation. One notes that $\beta_{6,7}$ will be used in every computation.

```{r,echo=FALSE,message=FALSE,warning=FALSE}
#             CovidBefore  CovidIn        CovidLater
# Away         Baseline      b_2               b_3
# Home          b_1      b_1+b_2+b_4      b_1+b_2+b_5

row1 <- c("Baseline","$\\beta_2$","$\\beta_3$")
row2 <- c("$\\beta_1$","$\\beta_1+\\beta_2+\\beta_4$","$\\beta_1+\\beta_3+\\beta_5$")

table <- data.frame(rbind(row1,row2))
names(table) <- c("Before Covid","During Covid","After Covid")
row.names(table) <- c("Away","Home")
table %>% kable(digit=3,caption = "Description of the Poisson Regression model ($\\beta_{6,7}$ are ommited)") %>% kable_styling()

```

In order to apply this model, one has to make some assumptions about the data and what the results will look like:

* We do not make a difference for the coefficients of a given team with respect to each season, therefore a given team will have the same coefficient between 2019 and 2022. One more step would be to make another boolean value with respect to the season or check the betting values to evaluate the strength of a given team with respect to the years, but that is out of the scope of this project.
* We do not take the relegation or promotion from the Premier League into account. This means that we do not remove those teams and therefore that the coefficients regarding certain teams might not be highly accurate as the number of games played by those relegated/promoted teams might be quite low.

## Model

We can now describe our model :

```{r}
prm <- glm(goals ~ team + opponent + home + covid + covid:home - 1,
           data=Data, 
           family=poisson(link="log"))
```

As seen above, we have the response `goals` which is the number of goals scored by `team` during a match against `opponent`. Then, we try to predict this response by using the `team` and `opponent` factor, as well as the `covid` and `home` flag previously described. We also add the interaction between `covid` and `home` which enables us to more precisely describe the link between the home effect and whether the game was played before, during or after Covid. One notes that we removed any intercept in the model and when comparing this model with some without any intercept and teams, we see that the teams' coefficients are the one containing this information, and that the coefficients for home and Covid stay the same, which is a good stability property (this can be seen in [Comparison of models]).

The main result from Poisson Regression theory that will be used afterwards is related to the marginal effect of a given variable, meaning that having a look at the coefficients $\beta$, we help us understand the proportional change in expected frequency. If we let $x=(x_1,...,x_p)^T$ and $\tilde{x}(j)=(x_1,...,x_{jâˆ’1},x_j+1,x_{j+1},...,x_p)^T$, then $\exp(\beta_j) = \frac{\mathbb{E}[Y_n |X_n = \tilde{x}(j)]}{\mathbb{E}[Y_n|X_n=x]}$, meaning that $\exp(\beta_j)$ is the expected change in the response when the j-th variable increases by one. This is particularly interesting when looking at our factors `home` and `covid` and their interactions as computing the exponential of their respective coefficients will give us insight about how the number of expected goals change when those factors are equal to zero or one.

# Did home advantage persist through Covid?

Now that we have a model which enables us to understand how the number of expected goals react to the teams playing, whether before, during or after covid, at home or away, we can tackle the main part of this project. To answer the main question, we will answer three subsidiary questions to grasp the home advantage phenomenon a bit better:

* Was there home advantage before Covid?
* Did home advantage reduced during Covid?
* How did it evolved after Covid?

To answer those questions, one can have a look at the summary of the model which can be found in full here : [Summary of the model] and in a simplified version below:

```{r,echo=FALSE,warning=FALSE,message=FALSE}
sum <- summary(prm)
sum_fact <- sum$coefficients[52:56,] 
row.names(sum_fact) <- c("$\\beta_1$","$\\beta_2$","$\\beta_3$","$\\beta_4$","$\\beta_5$")

conf_int <- confint(prm,parm = c("home1","covidin","covidlater","home1:covidin","home1:covidlater"))
row.names(conf_int) <- c("$\\beta_1$","$\\beta_2$","$\\beta_3$","$\\beta_4$","$\\beta_5$")

sum_fact <- cbind(sum_fact,conf_int)

sum_fact %>% kable(digit=3,caption = "Estimations of coefficients for interesting factors") %>% kable_styling()
```

We also computed confidence intervals which help us know whether there is a large variance on those estimates, which might blur the results and decrease the confidence we would have in the estimate itself and the consequences of their values. To do so, one can compute confidence intervals for each of the coefficients used, mainly $\beta_{1:5}$ using the `confint` R command. One notes that this command returns the Profile Likelihood CIs, and not the Wald which can be computed using `confint.default` but assumes normality.

## Was there a home advantage before Covid?

To statistically answer this question, one needs to take a look at the coefficients in front of the `home` variable. As the baseline factor for Covid is `before`, one finds that the home effect before Covid will be approximately $\exp(\beta_1)=1.21$. This means that, on average, when a team is playing at home, it gets $21\%$ times more goals than when playing away, all other parameters being equal before Covid hits. When looking at the $95\%$ confidence interval, we see that playing at home before covid indeed gives the team a positive effect, as the lower and upper bound are positive. Namely, we get that the home effect is between $10\%$ and $33\%$ with a $95\%$ confidence interval.

## Did home advantage reduced during Covid?

To tackle this question, one can have a look at the interaction between the `home` and the `covidIn` flag. By using the same strategy as the previous question, we can simply sum the coefficients of `home` and `home:covidIn` which will give us the coefficient of the home advantage during Covid. One finds $\exp(\beta_1 + \beta_4) = \exp(0.194 + -0.187) = 1.01$, meaning that on average during Covid, the home advantage has nearly no impact on the expected goals, as playing at home will only increase the number of goals by $1\%$, which is highly reduced from before Covid ($21\%$). When looking at the CIs, we observe that both upper and lower bounds of the interaction between `home` and `covidIn` are negative, which shows that there is a reduction of the home effect during the lock-down period. More precisely, we get a reduction of the home effect between $3\%$ and $28%$.

## How did it evolved after Covid? 

After Covid, we can check the coefficient of `home:CovidLater` which is equal to $\beta_5 = -0.05$, meaning that there will be a slight decrease of the home effect after Covid hits, but it does not cancels as during the Covid lockdowns. Quantitatively, the home advantage after Covid is equal to $\exp(0.194-0.05) = 1.15$, meaning that there is on average a $15%$ increase of number of expected goals after Covid due to home effect. However, when looking at the CIs,  things get a little more tricky. In fact, we observe that the home effect after Covid hits gets a multiplicative factor ranging from $0.82$ to $1.11$ which means that in reality, with this $95\%$ confidence level, one can not conclude whether there was an increase or a decrease of the home effect after Covid hit with respect to its value before Covid.


To wrap it up for this section, we can conclude that the Covid wave had a negative effect on the existing home advantage. When looking at the estimates of the coefficients, it even totally cancels the home effect during the lockdown period. After covid, we saw on average a slight decrease from pre-covid levels but the home advantage was back, even if we have to take those results with a grain of salt due to the confidence intervals' values.


# Additional studies

## Residuals

```{r,echo=FALSE,warning=FALSE,message=FALSE}

Data %>% mutate_if(is.factor,as.numeric) %>% 
                   mutate(res=resid(prm)) %>%
  pivot_longer(-res) %>% ggplot(aes(y=res,x=value)) + 
  labs(title = "Residuals vs Variable plot", 
       caption="Fig 1 : Residuals points and smoothing function wrt. covariate values",
       y = "Residuals", x = "Variable value")+ 
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=10,face="bold"),
        title= element_text(size=15,face="bold"),
        plot.caption = element_text(size=12))+ 
  facet_wrap(~ name, scales = "free") + geom_point() + geom_smooth()
```

At first glance, we observe a pretty flat residuals for all the variables which were used in our prediciton, which is a good sign. We also observe a few bigger residuals when playing during covid. There are also some teams and opponents which have higher residuals than other, as seen above.

## What happens if we remove the imbalanced season (19-20)
```{r}
start1 <- 381
end1 <- 640
start2 <- start1+1400
end2 <- end1+1400
indices <- c(start1:end1,start2:end2)
Data_wo1920 <- Data[-indices,]

prm_wo1920 <- glm(goals ~ team + opponent + home + covid + covid:home - 1,
                  data=Data_wo1920, 
                  family=poisson(link="log"))

sum_wo1920 <- summary(prm_wo1920)
sum_fact_wo1920 <- sum_wo1920$coefficients[52:56,] 
row.names(sum_fact_wo1920) <- c("$\\beta_1$","$\\beta_2$","$\\beta_3$","$\\beta_4$","$\\beta_5$")
sum_fact_wo1920 %>% kable(digit=3,caption = "Estimations of coefficients for interesting factors - without 2019-2020") %>% kable_styling()

```

Unsurprisingly, 
## Larger model

```{r,echo=FALSE,message=FALSE,warning=FALSE}
cols <- intersect(intersect(intersect(names(m_1819), names(m_1920)),names(m_2021)),names(m_2122))

cols <- cols[-c(1,2)]

full_data <- rbind(m_1819[,cols],m_1920[,cols],m_2021[,cols],m_2122[,cols])

team_names <- cols
team_names[1] <- "team"
team_names[2] <- "opponent"
team_names[3] <- "goals"
team_names[4] <- "opponent_goals"
team_names[5] <- "result"
team_names[6] <- "ht_goals"
team_names[7] <- "ht_opponent_goals"
team_names[8] <- "ht_result"
team_names[10] <- "team_shots"
team_names[11] <- "opponent_shots"
team_names[12] <- "team_shots_on_target"
team_names[13] <- "opponent_shots_on_target"
team_names[14] <- "team_fouls"
team_names[15] <- "opponent_fouls"
team_names[16] <- "team_corners"
team_names[17] <- "opponent_corners"
team_names[18] <- "team_yellow"
team_names[19] <- "opponent_yellow"
team_names[20] <- "team_red"
team_names[21] <- "opponent_red"

away_names <- cols
away_names[1] <- "opponent"
away_names[2] <- "team"
away_names[3] <- "opponent_goals"
away_names[4] <- "goals"
away_names[5] <- "result"
away_names[6] <- "ht_opponent_goals"
away_names[7] <- "ht_goals"
away_names[8] <- "ht_result"
away_names[10] <- "opponent_shots"
away_names[11] <- "team_shots"
away_names[12] <- "opponent_shots_on_target"
away_names[13] <- "team_shots_on_target"
away_names[14] <- "opponent_fouls"
away_names[15] <- "team_fouls"
away_names[16] <- "opponent_corners"
away_names[17] <- "team_corners"
away_names[18] <- "opponent_yellow"
away_names[19] <- "team_yellow"
away_names[20] <- "opponent_red"
away_names[21] <- "team_red"

full_AwayData <- full_data
full_AwayData$home = 0
names(full_AwayData) <- c(away_names,"home")

full_data$home = 1
names(full_data) <-  c(team_names,"home")

full_data <- rbind(full_data,full_AwayData)

full_data <- full_data %>% mutate(result = as.factor(result),
                                  ht_result = as.factor(ht_result),
                                  Referee = as.factor(Referee),
                                  team=as.factor(team),
                                  opponent = as.factor(opponent),
                                  covid = as.factor(covid),
                                  home = as.factor(home))

full_prm <- glm(goals ~ . + home:covid, data=full_data, family=poisson(link="log"))

anova(full_prm,prm) # way better model for prediction

sum_full <- summary(full_prm)
covidin <- sum_full$coefficients[120,]
covidlater <- sum_full$coefficients[121,]
home1 <- sum_full$coefficients[122,]
covidin_home1 <- sum_full$coefficients[123,]
covidlater_home1 <- sum_full$coefficients[124,]

sum_full_fact <- rbind(home1,covidin,covidlater,covidin_home1,covidlater_home1)

row.names(sum_full_fact) <- c("$\\beta_1^{full}$","$\\beta_2^{full}$","$\\beta_3^{full}$","$\\beta_4^{full}$","$\\beta_5^{full}$")
sum_full_fact %>% kable(digit=3,caption = "Estimations of coefficients for interesting factors - full model") %>% kable_styling()
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}
full_conf_int <- confint(full_prm,parm=c("home1","covidin","covidlater","covidin:home1","covidlater:home1"))
row.names(full_conf_int) <- c("$\\beta_1^{full}$","$\\beta_2^{full}$","$\\beta_3^{full}$","$\\beta_4^{full}$","$\\beta_5^{full}$")
full_conf_int %>% kable(digit=3,caption = "Confidence intervals for the coefficients") %>% kable_styling()
```

# Conclusion


# Appendix

## Summary of the model

```{r,echo=FALSE,warning=FALSE,message=FALSE}
tot_sum <- summary(prm)$coefficients
tot_confint <- confint(prm) 

tot_sum <- cbind(tot_sum,tot_confint)

tot_sum %>% kable(digit=3,caption = "Estimations of coefficients for all factors") %>% kable_styling()
```


## Comparison of models

```{r,echo=FALSE,message=FALSE,warning=FALSE}

prm_wo_teams <- glm(goals ~ home + covid + covid:home - 1, data=Data, family=poisson(link="log"))
prm_wo_teams_inter <- glm(goals ~ home + covid + covid:home, data=Data, family=poisson(link="log"))


print(paste0("Without team AIC: ", AIC(prm_wo_teams))) # AIC: 8597.7
print(paste0("With team AIC: ", AIC(prm))) # AIC: 8597.7

print("CIC without vs with teams")
print(paste0("Without team BIC: ", BIC(prm_wo_teams))) # 8633.309
print(paste0("With team BIC: ", BIC(prm))) # 8480.303

anova(prm,prm_wo_teams) # deviance : -549.88

summary(prm_wo_teams_inter)

summary(prm)

```
