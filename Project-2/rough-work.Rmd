---
title: "Rough-Work"
author: "Eliott Van Dieren"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(car)
library(knitr)
library(kableExtra)
library(pROC)

load("2_online_shopping.RData")
```

## Renaming and factoring data thanks to histogram

```{r, echo=FALSE, message=FALSE,warning=FALSE}
names(Data) <- c("n_admin_page","time_admin_page","n_info_page",
                 "time_info_page","n_product_page","time_product_page",
                 "bounce_rates","exit_rates","page_values","special_day",
                 "month","os","browser","region","traffic_type","visitor_type",
                 "weekend","purchase")

factors <- 11:18

# Factored data
Data_f <- Data %>% mutate(os=as.factor(os), browser=as.factor(browser),
                        region=as.factor(region),weekend = as.factor(weekend),
                        traffic_type=as.factor(traffic_type),
                        purchase=as.factor(purchase),month=as.factor(month),
                        visitor_type=as.factor(visitor_type))

# Merging the factored data
for (i in factors){
  count_table <- table(Data_f[,i])
  Data_f[,i] <- fct_collapse(Data_f[,i],other=names(count_table[count_table<50]))
}

quotient_prod <- rep(0, nrow(Data_f)) # initialize the quotient vector
zero_denom_prod <- which(Data_f[, "n_product_page"] == 0) # find indices where denominator is 0
quotient_prod[-zero_denom_prod] <- Data_f[, "time_product_page"][-zero_denom_prod] / Data_f[, "n_product_page"][-zero_denom_prod]

quotient_info <- rep(0, nrow(Data_f)) # initialize the quotient vector
zero_denom_info <- which(Data_f[, "n_info_page"] == 0) # find indices where denominator is 0
quotient_info[-zero_denom_info] <- Data_f[, "time_info_page"][-zero_denom_info] / Data_f[, "n_info_page"][-zero_denom_info]

quotient_admin <- rep(0, nrow(Data_f)) # initialize the quotient vector
zero_denom_admin <- which(Data_f[, "n_admin_page"] == 0) # find indices where denominator is 0
quotient_admin[-zero_denom_admin] <- Data_f[, "time_admin_page"][-zero_denom_admin] / Data_f[, "n_admin_page"][-zero_denom_admin]

Data_f <- Data_f %>% mutate(time_product_page = quotient_prod,time_admin_page = quotient_admin,time_info_page = quotient_info)

# verif "other" factor
table(Data_f$browser)


AUC_eval <- function(gmodel,Data){
  set.seed(517)
  Folds <- matrix(sample(1:dim(Data)[1]), ncol=5)
  AUC <- rep(0,5)
  for(k in 1:5){
    train <- Data[-Folds[,k],]
    test <- Data[Folds[,k],]
    my_gm <- glm(gmodel$formula, family="binomial", data=train)
    test_pred <- predict(my_gm, newdata = test, type="response")
    AUC[k] <- auc(test$purchase,test_pred)
}
  return(mean(AUC))
}

```


By having a closer look to the data, we can identify factors such as the 

Above, we created two dataset, one factoring and merging low categorical values (ex. browser etc). We also created a numerical dataset for histogram plotting where the visitor_type became 1,2,3 being New_Visitor, Other and Returning_Visitor

```{r,warning=FALSE}
#par(mfrow=c(2,n_cols/2 + n_cols%%2))
#for(i in 1:n_cols){
#  hist(as.numeric(Data[,i]),
#                  main = paste("Histogram of", names(Data)[i]))
#}

# Histogram plotting
par(mfrow=c(2,9))
Data_f %>% mutate_if(is.factor,as.numeric) %>% pivot_longer(everything()) %>% ggplot(aes(value)) +
  facet_wrap(~ name, scales = "free") + geom_histogram()
```
Comment this original dataset and talk about the merging and factoring certain values from those histograms distributions

```{r,warning=FALSE}
gm0 <- glm(purchase~., data=Data_f,family = "binomial")
Anova(gm0,type=2,test="LR")
cat(AUC_eval(gm0,Data_f))
```
The above test tells us what happens when we are dropping a single predictor from a saturated model. Here we observe that traffic_type, the month, exit_rates, n_product_page (prior, it was time_product_page), page_values and visitor type are statistically significant. Type II -> "Leave one out" meaning that the order does not manner. So we know that those variable with * are important

```{r,warning=FALSE}
#gm_t <- glm(purchase~.*weekend, data=Data_f,family = "binomial")
#Anova(gm_t,type=2,test="LR")
```
visitor_type:weekend might be interested, os:weekend also but might not be really relevant if we think about it. The first makes more sense, as visitor type might change depending on the day of the week


## Contingency tables for factor covariate

```{r,warning=FALSE}
table(Data_f$purchase, Data_f$visitor_type)
```
With those 2-way tables cross classifying the outcome depending on the type of visitor, we observe that there is 25% of buying when new visitors, and 15% for returning visitors, but there is much more volume for the returning visitors than the new visitors. Without doing a formal test, those percentages seem already different.

```{r,warning=FALSE}
table(Data_f$purchase, Data_f$month)
```

```{r,warning=FALSE}
table(Data_f$purchase, Data_f$month)
```

```{r,warning=FALSE}
only_sig_model <- glm(purchase ~ n_product_page+time_product_page+exit_rates+page_values+month+traffic_type+visitor_type,data=Data_f,family="binomial")
#week_end <- glm(purchase ~ time_product_page+exit_rates+page_values+month+traffic_type+visitor_type + weekend,data=Data_f,family="binomial")


#anova(gm0,only_sig_model,test="LRT")

AUC_eval(only_sig_model,Data_f) # better :)

# library(flexmix)
# BIC(only_sig_model) better bic than the gm0
# BIC(gm0)
# +visitor_type:weekend+I(page_values^2) + I(time_product_page^2
# Anova(only_sig_model,type=2,test="LR") all relevant (normal)
Data_f %>% mutate_if(is.factor,as.numeric) %>%
  mutate(res=resid(only_sig_model)) %>%
  pivot_longer(-res) %>% ggplot(aes(y=res,x=value)) +
  facet_wrap(~ name, scales = "free") + geom_point() + geom_smooth()
```
We can see a quadratic relation between page_values and a split there too. Let's create an enhanced model from the residual plots


```{r,warning=FALSE}
enhanced <- glm(purchase ~ n_product_page+time_product_page+exit_rates+page_values+month+traffic_type+visitor_type + I(page_values^2) + I(page_values^3),data=Data_f,family="binomial")
Anova(enhanced,type=2,test="LR") # checking for relevancy
#anova(only_sig_model,enhanced,test="LRT") # so really better
AUC_eval(enhanced,Data_f)

Data_f %>% mutate_if(is.factor,as.numeric) %>%
  mutate(res=resid(enhanced)) %>%
  pivot_longer(-res) %>% ggplot(aes(y=res,x=value)) +
  facet_wrap(~ name, scales = "free") + geom_point() + geom_smooth()

```
Now, it is time to check for interactions

```{r,warning=FALSE}
table(Data_f$weekend, Data_f$visitor_type)
```

Checking visitors on the week-end vs during the work week gives us different percentages, might be interesting as interaction and finding new clusters of customers.



```{r,warning=FALSE}

enhanced_wk_vist <- glm(purchase ~ n_product_page+time_product_page+exit_rates+page_values+month+traffic_type+visitor_type + I(page_values^2) + I(page_values^3) + weekend:visitor_type,data=Data_f,family="binomial")

Anova(enhanced_wk_vist,type=2,test="LR")
AUC_eval(enhanced_wk_vist,Data_f)
AUC_eval(enhanced,Data_f)
```

See the final report for the models and final calculations
`

